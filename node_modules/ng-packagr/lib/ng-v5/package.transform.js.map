{"version":3,"file":"package.transform.js","sourceRoot":"","sources":["../../../src/lib/ng-v5/package.transform.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'path';\nimport { Observable, concat as concatStatic, from as fromPromise, of as observableOf, pipe } from 'rxjs';\nimport { concatMap, map, retry, switchMap, takeLast, tap } from 'rxjs/operators';\nimport { BuildGraph } from '../brocc/build-graph';\nimport { DepthBuilder, Groups } from '../brocc/depth';\nimport { Node, STATE_IN_PROGESS } from '../brocc/node';\nimport { Transform } from '../brocc/transform';\nimport * as log from '../util/log';\nimport { rimraf } from '../util/rimraf';\nimport { PackageNode, EntryPointNode, ngUrl, isEntryPoint, byEntryPoint } from './nodes';\nimport { discoverPackages } from './discover-packages';\nimport { copyFile } from '../util/copy';\n\n/**\n * A transformation for building an npm package:\n *\n *  - discoverPackages\n *  - initTsConfig\n *  - analyzeTsSources (thereby extracting template and stylesheet files)\n *  - for each entry point\n *    - run the entryPontTransform\n *  - writeNpmPackage\n *\n * @param project Project token, reference to `ng-package.json`\n * @param initTsConfigTransform Transformation initializing the tsconfig of each entry point.\n * @param analyseSourcesTransform Transformation analyzing the typescript source files of each entry point.\n * @param entryPointTransform Transformation for asset rendering and compilation of a single entry point.\n */\nexport const packageTransformFactory = (\n  project: string,\n  initTsConfigTransform: Transform,\n  analyseSourcesTransform: Transform,\n  entryPointTransform: Transform\n) => (source$: Observable<BuildGraph>): Observable<BuildGraph> => {\n  const pkgUri = ngUrl(project);\n\n  return source$.pipe(\n    tap(() => {\n      log.info(`Building Angular Package`);\n    }),\n    // Discover packages and entry points\n    switchMap(graph => {\n      const pkg = discoverPackages({ project });\n\n      return fromPromise(pkg).pipe(\n        map(value => {\n          const ngPkg = new PackageNode(pkgUri);\n          ngPkg.data = value;\n\n          return graph.put(ngPkg);\n        })\n      );\n    }),\n    // Clean the primary dest folder (should clean all secondary sub-directory, as well)\n    switchMap(graph => {\n      const { dest, deleteDestPath } = graph.get(pkgUri).data;\n      return fromPromise(deleteDestPath ? rimraf(dest) : Promise.resolve());\n    }, (graph, _) => graph),\n    // Add entry points to graph\n    map(graph => {\n      const ngPkg = graph.get(pkgUri);\n      const entryPoints = [ngPkg.data.primary, ...ngPkg.data.secondaries].map(entryPoint => {\n        const { destinationFiles, moduleId } = entryPoint;\n        const node = new EntryPointNode(ngUrl(moduleId));\n        node.data = { entryPoint, destinationFiles };\n        node.state = 'dirty';\n        ngPkg.dependsOn(node);\n\n        return node;\n      });\n\n      return graph.put(entryPoints);\n    }),\n    // Initialize the tsconfig for each entry point\n    initTsConfigTransform,\n    // Analyse dependencies and external resources for each entry point\n    analyseSourcesTransform,\n    // Next, run through the entry point transformation (assets rendering, code compilation)\n    scheduleEntryPoints(entryPointTransform),\n    // Write npm package to dest folder\n    writeNpmPackage(pkgUri),\n    tap(graph => {\n      const ngPkg = graph.get(pkgUri);\n      log.success(`Built Angular Package!\n- from: ${ngPkg.data.src}\n- to:   ${ngPkg.data.dest}`);\n    })\n  );\n};\n\nconst writeNpmPackage = (pkgUri: string): Transform =>\n  pipe(\n    switchMap(graph => {\n      const { data } = graph.get(pkgUri);\n      const filesToCopy = Promise.all(\n        [`${data.src}/LICENSE`, `${data.src}/README.md`].map(src =>\n          copyFile(src, path.join(data.dest, path.basename(src)))\n        )\n      );\n\n      return fromPromise(filesToCopy).pipe(map(() => graph));\n    })\n  );\n\nconst scheduleEntryPoints = (epTransform: Transform): Transform =>\n  pipe(\n    concatMap(graph => {\n      // Calculate node/dependency depth and determine build order\n      const depthBuilder = new DepthBuilder();\n      const entryPoints = graph.filter(isEntryPoint);\n      entryPoints.forEach(entryPoint => {\n        const deps = entryPoint.filter(isEntryPoint).map(ep => ep.url);\n        depthBuilder.add(entryPoint.url, deps);\n      });\n\n      // The array index is the depth.\n      const groups = depthBuilder.build();\n      const flattenedGroups = groups.reduce((prev, current) => prev.concat(current), []);\n      let currentIndex = 0;\n\n      // Build entry points with lower depth values first.\n      const eps$ = flattenedGroups.map(() =>\n        observableOf(graph).pipe(\n          tap(() => {\n            // Find current entry point in progress\n            const epUrl = flattenedGroups[currentIndex];\n            const entryPoint = graph.find(byEntryPoint().and(ep => ep.url === epUrl));\n\n            // Mark the entry point as 'in-progress'\n            entryPoint.state = STATE_IN_PROGESS;\n          }),\n          epTransform,\n          tap(() => {\n            currentIndex += 1;\n          })\n        )\n      );\n\n      // Build all entry points, then continue\n      return concatStatic(...eps$).pipe(takeLast(1));\n    })\n  );\n"]}